<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Failure Detection Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h2>Failure Detection Dashboard</h2>
            <div id="status-indicator" class="status-badge">WAITING</div>
        </header>

        <div class="main-content" id="main-content">
            <div class="camera-grid" id="camera-grid">

                <!-- CAMERA 1 -->
                <div class="camera-card" id="card-cam1">
                    <div class="cam-header"><h3>Primary Camera</h3></div>

                    <div class="camera-viewport" id="cam1-container">
                        <img id="cam1-img" class="live-feed" alt="">
                        <div class="disabled-overlay" id="cam1-overlay"><span>DISABLED</span></div>
                    </div>
                    
                    <div class="cam-stats" id="cam1-stats">
                        <div class="cam-stats-inner">
                            <div class="cam-stat-row">Detections: <span class="detect-count" id="cam1-detect-count">0</span></div>
                            <div class="cam-stat-row">Failures: <span class="fail-count" id="cam1-fail-count">0</span></div>
                        </div>
                    </div>
                    
                    <div class="cam-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" id="cam1-toggle">
                            <span class="slider"></span>
                            <span class="label-text">Active</span>
                        </label>
                    </div>

                    <div class="mask-tools">
                        <button id="cam1-clear-masks" class="secondary-btn">Clear Masks</button>
                    </div>
                </div>

                <!-- CAMERA 2 -->
                <div class="camera-card" id="card-cam2">
                    <div class="cam-header"><h3>Secondary Camera</h3></div>

                    <div class="camera-viewport" id="cam2-container">
                        <img id="cam2-img" class="live-feed" alt="">
                        <div class="disabled-overlay" id="cam2-overlay"><span>DISABLED</span></div>
                    </div>

                    <div class="cam-stats" id="cam2-stats">
                        <div class="cam-stats-inner">
                            <div class="cam-stat-row">Detections: <span class="detect-count" id="cam2-detect-count">0</span></div>
                            <div class="cam-stat-row">Failures: <span class="fail-count" id="cam2-fail-count">0</span></div>
                        </div>
                    </div>
                    
                    <div class="cam-controls">
                        <label class="toggle-switch">
                            <input type="checkbox" id="cam2-toggle">
                            <span class="slider"></span>
                            <span class="label-text">Active</span>
                        </label>
                    </div>

                    <div class="mask-tools">
                        <button id="cam2-clear-masks" class="secondary-btn">Clear Masks</button>
                    </div>
                </div>

            </div>

            <!-- CENTER MASK INFO -->
            <div id="mask-help-center">
                <p class="help-box">
                    Click and drag on the camera to add mask zones. Right-click a zone to remove it. Click 'Visualize Mask' to show the mask overlay.
                </p>
            </div>

            <!-- HEALTH BAR -->
            <div class="health-section">
                <div class="health-header">
                    <span>Failure Probability: <span id="ssim-val">--%</span></span>
                    <span>Retries: <span id="retry-val">0/0</span></span>
                </div>
                <div class="progress-track">
                    <span id="monitoring-label" class="monitoring-label"></span>
                    <div id="confidence-bar" class="progress-fill"></div>
                </div>
            </div>

            <!-- CONTROLS -->
            <div class="controls">

                <button id="mask-toggle-btn" class="secondary-btn">Visualize Mask</button>

                <button id="force-start-btn" class="primary-btn btn-success">
                    ▶ Start Monitoring
                </button>

                <button id="open-settings-btn" class="secondary-btn">⚙️ Settings</button>

            </div>

        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-overlay"></div>
    <dialog id="settings-modal">
        <div class="modal-header">
            <h3>Configuration</h3>
            <button id="close-modal-x" class="icon-btn">×</button>
        </div>

        <div id="settings-pages">

            <!-- PAGE 1 — MAIN SETTINGS -->
            <div id="settings-page">
                <div class="modal-body settings-grid">

                    <!-- CAMERA SETUP -->
                    <div class="setting-group">
                        <h4>Camera Setup</h4>

                        <div class="setting-row">
                            <label>Camera Count:</label>
                            <select id="camera_count">
                                <option value="1">1 Camera</option>
                                <option value="2">2 Cameras</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label>Cam 1 URL:</label>
                            <input type="text" id="cam1_url_input">
                        </div>

                        <div class="setting-row">
                            <label>Cam 1 Aspect Ratio:</label>
                            <select id="cam1_aspect_ratio">
                                <option value="16:9">16:9</option>
                                <option value="4:3">4:3</option>
                            </select>
                        </div>

                        <div class="setting-row" id="cam2-settings-row">
                            <label>Cam 2 URL:</label>
                            <input type="text" id="cam2_url_input">
                        </div>

                        <div class="setting-row" id="cam2-aspect-row">
                            <label>Cam 2 Aspect Ratio:</label>
                            <select id="cam2_aspect_ratio">
                                <option value="16:9">16:9</option>
                                <option value="4:3">4:3</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label>Moonraker URL:</label>
                            <input type="text" id="moonraker_url">
                        </div>
                    </div>

                    <!-- FAILURE RESPONSE -->
                    <div class="setting-group">
                        <h4>Failure Response</h4>

                        <div class="setting-row">
                            <label>Check Interval (ms):</label>
                            <input type="number" id="check_interval" min="100" step="100">
                        </div>

                        <div class="help-tooltip">
                            <span class="help-icon">?</span>
                            <div class="help-tooltip-text">
                                How often printer and camera state are checked. Lower values update faster but use more CPU.
                            </div>
                        </div>

                        <div class="setting-row">
                            <label for="infer_every_n_loops">AI Inference Rate:</label>
                            <select id="infer_every_n_loops">
                                <option value="1">Every frame (max accuracy)</option>
                                <option value="2">Every 2 frames (recommended)</option>
                                <option value="3">Every 3 frames (high performance)</option>
                                <option value="4">Every 4 frames (higher performance)</option>
                            </select>
                        </div>

                        <div class="help-tooltip">
                            <span class="help-icon">?</span>
                            <div class="help-tooltip-text">
                                Runs AI less often to reduce CPU load but will slightly delay detection. "frames" = Check Interval.
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <label>Max Retries:</label>
                            <input type="number" id="consecutive_failures">
                        </div>

                        <div class="help-tooltip">
                            <span class="help-icon">?</span>
                            <div class="help-tooltip-text">
                                Number of consecutive failures detected before action is taken.
                            </div>
                        </div>

                        <div class="setting-row">
                            <label>Failure Action:</label>
                            <select id="on_failure">
                                <option value="nothing">Warning Only</option>
                                <option value="pause">Pause Print</option>
                                <option value="cancel">Cancel Print</option>
                            </select>
                        </div>
                        
                    </div>

                    <!-- AI CATEGORY BUTTON CARD -->
                    <div class="setting-group">
                        <h4>AI Categories</h4>
                        <div class="ai-cat-btn-container">
                            <button id="open-ai-cat-btn" class="secondary-btn">Edit AI Category Settings</button>
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button id="save-settings-btn" class="primary-btn">Save Configuration</button>
                </div>
            </div>


            <!-- PAGE 2 — AI CATEGORY SETTINGS -->
            <div id="ai-page">
                <div class="modal-body ai-cat-page-body">

                    <h4>AI Category Settings</h4>

                    <div class="ai-cat-body">

                        <div class="ai-col">
                            <div class="ai-cat-card">
                                <h5>Spaghetti</h5>
                                <label><input type="checkbox" id="cat_spaghetti_enabled"> Enabled</label>
                                <label><input type="checkbox" id="cat_spaghetti_trigger"> Can Trigger Failure</label>
                                <label>Detection Threshold (%):
                                    <input type="number" id="cat_spaghetti_detect_threshold" min="0" max="100">
                                </label>

                                <label>Trigger Threshold (%):
                                    <input type="number" id="cat_spaghetti_trigger_threshold" min="0" max="100">
                                </label>
                            </div>

                            <div class="ai-cat-card">
                                <h5>Blobs</h5>
                                <label><input type="checkbox" id="cat_blob_enabled"> Enabled</label>
                                <label><input type="checkbox" id="cat_blob_trigger"> Can Trigger Failure</label>
                                <label>Detection Threshold (%):
                                    <input type="number" id="cat_blob_detect_threshold" min="0" max="100">
                                </label>

                                <label>Trigger Threshold (%):
                                    <input type="number" id="cat_blob_trigger_threshold" min="0" max="100">
                                </label>
                            </div>
                        </div>

                        <div class="ai-col">
                            <div class="ai-cat-card">
                                <h5>Cracks</h5>
                                <label><input type="checkbox" id="cat_crack_enabled"> Enabled</label>
                                <label><input type="checkbox" id="cat_crack_trigger"> Can Trigger Failure</label>
                                <label>Detection Threshold (%):
                                    <input type="number" id="cat_crack_detect_threshold" min="0" max="100">
                                </label>

                                <label>Trigger Threshold (%):
                                    <input type="number" id="cat_crack_trigger_threshold" min="0" max="100">
                                </label>
                            </div>

                            <div class="ai-cat-card">
                                <h5>Warping</h5>
                                <label><input type="checkbox" id="cat_warping_enabled"> Enabled</label>
                                <label><input type="checkbox" id="cat_warping_trigger"> Can Trigger Failure</label>
                                <label>Detection Threshold (%):
                                    <input type="number" id="cat_warping_detect_threshold" min="0" max="100">
                                </label>

                                <label>Trigger Threshold (%):
                                    <input type="number" id="cat_warping_trigger_threshold" min="0" max="100">
                                </label>
                            </div>
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button id="back-ai-btn" class="secondary-btn">Back</button>
                    <button id="save-ai-cat-btn" class="primary-btn">Save Category Settings</button>
                </div>
            </div>

        </div>
    
    </dialog>
    
<!-- Per-category stats modal -->
    <dialog id="stats-modal" class="modal stats-modal">
        <div class="modal-header">
            <h3 id="stats-modal-title">Camera Detection Breakdown</h3>
            <button id="close-stats-modal" class="icon-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="stats-table">
                <div class="stats-table-header">
                    <span>Category</span>
                    <span>Detections</span>
                    <span>Failures</span>
                </div>

                <div class="stats-table-row">
                    <span>Spaghetti</span>
                    <span id="stat-det-spaghetti">0</span>
                    <span id="stat-fail-spaghetti">0</span>
                </div>

                <div class="stats-table-row">
                    <span>Blobs</span>
                    <span id="stat-det-blob">0</span>
                    <span id="stat-fail-blob">0</span>
                </div>

                <div class="stats-table-row">
                    <span>Cracks</span>
                    <span id="stat-det-crack">0</span>
                    <span id="stat-fail-crack">0</span>
                </div>

                <div class="stats-table-row">
                    <span>Warping</span>
                    <span id="stat-det-warping">0</span>
                    <span id="stat-fail-warping">0</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="reset-stats-btn" class="secondary-btn">
                Reset Counters
            </button>
        </div>
    </dialog>

    <!-- Floating Log Button + Panel -->

    <!-- Floating toggle button -->
    <button id="log-toggle-btn" class="log-floating-btn">Logs ▾</button>

    <!-- Log panel -->
    <div id="log-panel" class="log-panel hidden">
        <div class="log-panel-header">
            <span>Plugin Log</span>
            <button id="log-close-btn" class="log-close-btn">✕</button>
        </div>
        <div id="log-content" class="log-content"></div>
    </div>

    <!-- END BLOCK -->

    <script src="script.js"></script>
</body>
</html>